<layout>
  <div class="right_col" role="main">
    <div class="container">


      <div class="page-title">
        <div class="title_left" style="display: flex; justify-content: space-between;">
          <div class="d-flex" style="align-items: center;">
            <a (click)="Back()" class="nav-link">
              <i class="fas fa-arrow-left" style="color: #5ba146;" title="Back"></i>
            </a>
            <h3>Spare Quote Details</h3>
          </div>

          <div class="controls" style="display: flex;">
            <a class="nav-link" (click)="EditMode()"
              *ngIf="hasUpdateAccess && !isEditMode && !isNewMode &&  !isCompleted">
              <i class="fas fa-pen" style="color: #5ba146;" title="Edit"></i>
            </a>

            <a class="nav-link" (click)="CancelEdit()" *ngIf="(isEditMode || isNewMode) && !isCompleted">
              <i class="fas fa-times" style="color: #5ba146;" title="Cancel"></i>
            </a>

            <a class="nav-link" (click)="onSubmit()"
              *ngIf="(hasUpdateAccess || hasAddAccess) && (isEditMode || isNewMode) && !isCompleted">
              <i class="fas fa-save" style="color: #5ba146;" title="Save"></i>
            </a>

            <a class="nav-link" (click)="DeleteRecord()" *ngIf="hasDeleteAccess">
              <i class="fas fa-trash" style="color: #5ba146;" title="Delete"></i>
            </a>
          </div>
        </div>
      </div>


      <div class="clearfix"></div>
      <hr />
      <div class="col-md-12 col-sm-12">
        <form [formGroup]="form">
          <div class="row">
            <div class="col-md-4 col-sm-4" [style.display]="hasId ? 'block' : 'none'">
              <label for="offReqNo">Spare Parts Quote No.</label>
              <input id="offReqNo" readonly type="text" formControlName="offReqNo" class="form-control" />
            </div>

            <div class="col-md-4 col-sm-4">
              <label for="Customer">Customer</label>
              <select id="Customer" type="text" formControlName="customerId" class="form-control" [ngClass]="{
                  ' is -invalid': submitted && f.customerId.errors
                }">
                <option *ngFor="let i of customerList" value="{{ i.id }}">
                  {{ i.custname }}
                </option>
              </select>
              <div Style="display: block" *ngIf="submitted && f.customerId.errors" class="invalid-feedback">
                <div *ngIf="f.customerId.errors.required">
                  Customer is required
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-4">
              <label for="distributor">Distributor</label>
              <select id="distributor" type="text" disabled formControlName="distributorid" class="form-control" [ngClass]="{
                  ' is -invalid': submitted && f.distributorid.errors
                }">
                <option *ngFor="let i of distributorList" value="{{ i.id }}">
                  {{ i.distname }}
                </option>
              </select>
              <div Style="display: block" *ngIf="submitted && f.distributorid.errors" class="invalid-feedback">
                <div *ngIf="f.distributorid.errors.required">
                  distributor is required
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-4" hidden>
              <label for="totalamount">Total Amount</label>
              <br />
              <select id="currency" style="display: inline-block; width: 100px" formControlName="currencyId"
                class="form-control" [ngClass]="{ ' is -invalid': submitted && f.currencyId.errors }">
                <option *ngFor="let i of currencyList" value="{{ i.id }}">
                  {{ i.code }}
                </option>
              </select>

              <input id="totalamount" type="number" formControlName="totalamount" class="form-control"
                style="display: inline-block; width: 270px; margin-left: 5px" [ngClass]="{
                  ' is -invalid': submitted && f.totalamount.errors
                }" />
              <div Style="display: block" *ngIf="submitted && f.totalamount.errors" class="invalid-feedback">
                <div *ngIf="f.totalamount.errors.required">
                  totalamount is required
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-4" hidden>
              <label for="status">Status</label>
              <input id="status" type="text" formControlName="status" class="form-control"
                [ngClass]="{ ' is -invalid': submitted && f.status.errors }" />
              <div Style="display: block" *ngIf="submitted && f.status.errors" class="invalid-feedback">
                <div *ngIf="f.status.errors.required">status is required</div>
              </div>
            </div>
            <div class="col-md-4 col-sm-4">
              <label for="podate">RFQ Date</label>
              <input id="podate" type="text" [disabled]="!isDist" bsDatepicker formControlName="podate"
                class="form-control" [ngClass]="{ ' is -invalid': submitted && f.podate.errors }" />
              <div Style="display: block" *ngIf="submitted && f.podate.errors" class="invalid-feedback">
                <div *ngIf="f.podate.errors.required">RFQ Date is required</div>
              </div>
            </div>
            <div class="col-md-4 col-sm-4" *ngIf="isDist">
              <label for="PaymentTerms">Payment Terms</label>
              <ng-select [settings]="dropdownSettings" [multiple]="true" [data]="payTypes"
                formControlName="paymentTerms">
                <ng-option *ngFor="let i of payTypes" value="{{i.listTypeItemId}}">{{i.itemname}}</ng-option>
              </ng-select>
              <div Style="display: block" *ngIf="submitted && f.paymentTerms.errors" class="invalid-feedback">
                <div *ngIf="f.paymentTerms.errors.required">
                  Payment Terms is required
                </div>
              </div>
            </div>


            <div class="col-sm-4">
              <label for="instrumentsList">Instruments</label>
              <ng-select formControlName="instrumentsList" [multiple]="true" id="instrumentsList" [virtualScroll]="true"
                [ngClass]="{'is-invalid':submitted && f.instrumentsList.errors }">
                <ng-option *ngFor="let i of instruments" value="{{i.id}}">{{i.instypeName}} - {{i.serialnos}}
                </ng-option>
              </ng-select>

              <div *ngIf="submitted && f.instrumentsList.errors" class="invalid-feedback">
                <div *ngIf="f.instrumentsList.errors.required">Instruments is required</div>
              </div>
            </div>

          </div>

          <div class="page-title">
            <div class="title_left">
              <h3 style="padding: 15px 0 5px 0">Add Spare Parts</h3>
            </div>
          </div>
          <div class="clearfix"></div>
          <hr />

          <div class="row" style="margin-top: 50px">
            <div class="col-md-9">
              <label for="browser">Search SpareParts By Part No. </label>
              <input [disabled]="isCompleted || (!isEditMode && !isNewMode)" (input)="
                  SparePartsSearch($event.target.value?.split('==>')[0]?.trim())
                " #sparePartsSearch list="browsers" name="browser" id="browser" class="form-control" />
              <datalist id="browsers">
                <option *ngFor="let i of sparePartsAutoComplete" value="{{ i.partno }} ==> {{ i.itemDescription }}">
                </option>
              </datalist>

              <p style="color: red">
                *If you dont find spare part above please add Description below
              </p>
            </div>

            <div class="col-md-3" style="margin-top: 30px">
              <button class="btn btn-primary" [disabled]="isCompleted || (!isEditMode && !isNewMode)" (click)="
                  AddSpareParts(sparePartsSearch.value?.split('==>')[0]?.trim())
                " type="button" class="btn btn-primary">
                Add SpareParts
              </button>
            </div>
          </div>

          <div class="row">
            <ag-grid-angular style="width: 100%; margin-top: 2.5%; height: 250px" class="ag-theme-alpine"
              (cellValueChanged)="onCellValueChanged($event)" (cellClicked)="RemoveSpareParts($event)"
              (gridReady)="onGridReady($event)" [columnDefs]="columnDefs" [rowData]="sparePartsList"
              rowSelection="single" pagination="true" paginationPageSize="10">
            </ag-grid-angular>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label for="otherSpareDesc">Description</label>
              <textarea id="otherSpareDesc" type="text" formControlName="otherSpareDesc"
                class="form-control"></textarea>
            </div>
          </div>
          <br />

          <div class="attachment my-4">
            <div class="page-title">
              <div class="title_left">
                <h3 style="padding: 15px 0 5px 0">Attachments</h3>
              </div>
            </div>
            <div class="clearfix"></div>
            <hr />

            <div class="row" *ngIf="hasUpdateAccess || hasAddAccess" style="margin: 15px">
              <div class="col-md-3">
                <input type="file" id="myFile" [disabled]="isCompleted || (!isEditMode && !isNewMode)" #file
                  placeholder="Choose file" (change)="getfil(file.files, true); listfile(file.files)" multiple
                  accept="text/plain, application/pdf, image/*" />
              </div>
              <div id="selectedfiles" class="hidden col-md-4"
                style="max-height: 200px; overflow-y: auto; display: none">
                <section style="
                    margin: 30px 0 0 50px;
                    max-width: 600px;
                    min-width: 300px;
                  ">
                  <h5>Selected Files:</h5>
                  <hr />
                </section>
              </div>
            </div>

            <ag-grid-angular *ngIf="hasId" style="width: 100%; height: 250px" class="my-4 ag-theme-alpine"
              (gridReady)="onGridReadyAttachments($event)" [columnDefs]="columnDefsAttachments" [rowData]="attachments"
              rowSelection="single" pagination="true" paginationPageSize="10">
            </ag-grid-angular>
          </div>

          <div class="offerRequestProccess" *ngIf="hasId">
            <div class="page-title">
              <div class="title_left">
                <div class="row">
                  <div class="col-md-10">
                    <h3 style="padding: 15px 0 5px 0">Spare Parts Quote Stages</h3>
                  </div>

                </div>
              </div>
            </div>
            <div class="clearfix"></div>
            <hr />
            <p style="color: red;">*Upload File Size should not exceed 10MB.</p>
            <table class="table">
              <thead>
                <tr>
                  <th *ngIf="(hasDeleteAccess || hasAddAccess )&& !isCompleted && isEditMode">Action</th>
                  <th>Stage</th>
                  <th>Comments</th>
                  <th>Date</th>
                  <th>Download File <i class="mx-2 fas fa-download"></i></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of rowData">
                  <td *ngIf="(hasDeleteAccess || hasAddAccess )&& !isCompleted && isEditMode">
                    <button type="button" *ngIf="hasDeleteAccess" (click)="deleteProcess(item.id)"
                      style="background-color: transparent;color: #5ba146;border: none;">
                      <i class="fas fa-trash-alt" title="Delete" style="font-size: 19px;"></i>
                    </button>
                  </td>

                  <td>{{item.stageName}}</td>

                  <td>
                    {{item.paymentType}} <br *ngIf="item.paymentType"><br *ngIf="item.paymentType">
                    <span *ngIf="item.payAmt">
                      {{item.payAmtCurrency}} {{item.payAmt}} <br /><br />
                    </span>
                    {{item.comments}}
                  </td>

                  <td>{{item.createdOn}}</td>
                  <td>
                    <app-ProcessFileRenderer [parameters]="item"></app-ProcessFileRenderer>
                  </td>
                </tr>
              </tbody>
              <tfoot *ngIf="hasAddAccess && !isCompleted && isEditMode"
                style=" background: whitesmoke; border: 0.5px solid rgb(202 170 170);">
                <tr>
                  <td>
                    <button type="button" *ngIf="hasAddAccess" (click)="submitStageData()"
                      style="background-color: transparent; color: #5ba146; border: none;">
                      <i class="fas fa-save" style="font-size: 20px;"></i>
                    </button>
                  </td>

                  <td style="width: 250px;">
                    <ng-select formControlName="stageName" id="stageName" (change)="onstageNameChanged($event)"
                      [virtualScroll]="true" [ngClass]="{'is-invalid':submitted && f.stageName.errors }">
                      <ng-option *ngFor="let i of stagesList" value="{{i.listTypeItemId}}">{{i.itemname}}
                      </ng-option>
                    </ng-select>

                    <div *ngIf="submitted && f.stageName.errors" class="invalid-feedback">
                      <div *ngIf="f.stageName.errors.required">Stage Name is required</div>
                    </div>
                  </td>
                  <td>

                    <div *ngIf="isPaymentTerms">

                      <label>Payment Type</label>
                      <select class="pay_terms form-control" formControlName="payterms" id="payment_type">
                        <option *ngFor="let i of paymentTypes" value="{{ i.listTypeItemId }}">
                          {{ i.itemname }}
                        </option>
                      </select>
                    </div>

                    <div *ngIf="isPaymentAmt">
                      <label>Payment Amount</label><br>
                      <select id="currency" type="text" style="display: inline-block; width: 30%;margin-right: 1%;"
                        formControlName="payAmtCurrencyId" class="form-control"
                        [ngClass]="{ ' is -invalid': submitted && f.currency.errors}">
                        <option *ngFor="let i of currencyList" value="{{i.id}}">
                          {{i.code}}
                        </option>
                      </select>
                      <input class="payAmt form-control" style="width:67%;display: inline-block;" type="number"
                        formControlName="payAmt" id="payAmt" />
                    </div>

                    <label for="stageComments" *ngIf="isPaymentTerms || isPaymentAmt">Comments</label>
                    <textarea formControlName="stageComments" class="form-control"
                      [ngClass]="{'is-invalid':submitted && f.stageComments.errors }"></textarea>

                    <div *ngIf="submitted && f.stageComments.errors" class="invalid-feedback">
                      <div *ngIf="f.stageComments.errors.required">Stage Comments is required</div>
                    </div>
                  </td>

                  <td></td>
                  <td>
                    <input multiple #stageFiles class="stageFilesList_class" type="file"
                      accept=".pdf, text/plain, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/msword,application/pdf"
                      (change)="
                      getfil(stageFiles.files);
                      listfile(stageFiles.files,'stageFilesList')" />

                    <div>
                      <input type="checkbox" [disabled]="isCompleted" (click)="DisableChoseFile('stageFilesList_class')"
                        id="stageFilesList_Attachment" />
                      <span> No Attachment</span>
                    </div>

                    <div id="stageFilesList" class="hidden" style="display: none; overflow-wrap: break-word;"></div>
                  </td>
                </tr>
              </tfoot>

            </table>

          </div>
        </form>
      </div>
    </div>
  </div>
</layout>

<style>
  th>button {
    padding: 6px 9px;
  }

  thead {
    background-color: #5ba146;
    color: white;
  }

  tbody {
    border: 0.5px solid rgb(202 170 170);
  }

  td>textarea {
    width: 300px;
  }
</style>